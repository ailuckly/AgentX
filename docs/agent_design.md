# Agent模块设计文档

## 1. 概述

Agent模块是AgentX系统的核心组件之一，负责管理和配置不同类型的智能体（Agent），并将它们与用户会话关联。每个Agent可以拥有独特的性格、知识背景和能力，为用户提供个性化的对话体验。

## 2. 核心功能

### 2.1 Agent管理

- Agent的创建、修改、删除和查询
- Agent属性配置（名称、头像、描述、系统提示词等）
- Agent模型配置（选择模型类型、调整参数等）
- Agent能力配置（可用工具、知识库等）

### 2.2 Agent与会话关联

- 将会话与指定Agent关联
- 支持会话中切换Agent
- 保存Agent与会话的关联历史

### 2.3 Agent高级功能

- Agent记忆管理（长期记忆、短期记忆）
- Agent个性化配置（性格特征、专业领域等）
- Agent能力扩展（允许配置特定工具集）

### 2.4 Agent工作区

- 用户可将常用Agent添加到个人工作区
- 工作区Agent将在界面中优先展示
- 支持管理和组织工作区中的Agent

## 3. 数据模型

### 3.1 核心实体

**Agent实体**：
- 基本信息（ID、名称、头像、描述等）
- 当前编辑中的配置（系统提示词、欢迎消息、模型配置、工具配置、知识库等）
- 版本管理（发布版本ID）
- 状态管理（通过status字段控制：私有/待审核/已上架/被拒绝/已下架）

**Agent版本**：
- 版本信息（版本号、发布时间等）
- 系统提示词（定义Agent的行为和风格）
- 欢迎消息（Agent首次对话时的问候语）
- 模型配置（使用的LLM模型、温度等参数）
- 工具配置（Agent可用的工具列表）
- 知识库配置（Agent可访问的知识库）
- 更新日志（版本更新说明）

**Agent工作区**：
- 记录用户添加到工作区的Agent
- 便于用户快速访问常用Agent

### 3.2 与其他模块的关系

- **会话模块**：Agent与会话是一对多关系，一个Agent可以关联多个会话
- **工具模块**：Agent可以配置可用的工具集
- **知识库模块**：Agent可以关联特定的知识库
- **用户模块**：用户可以创建、使用和添加Agent到工作区
- **市场模块**：Agent可以上架到市场供其他用户使用

## 4. API设计

### 4.1 Agent管理API

- `POST /api/agents` - 创建新Agent
- `GET /api/agents` - 获取Agent列表
- `GET /api/agents/{id}` - 获取Agent详情
- `PUT /api/agents/{id}` - 更新Agent基本信息
- `DELETE /api/agents/{id}` - 删除Agent

### 4.2 Agent版本API

- `POST /api/agents/{id}/versions` - 创建新版本
- `GET /api/agents/{id}/versions` - 获取版本列表
- `GET /api/agents/{id}/versions/{versionId}` - 获取版本详情
- `PUT /api/agents/{id}/versions/{versionId}` - 更新草稿版本
- `POST /api/agents/{id}/versions/{versionId}/publish` - 发布版本
- `POST /api/agents/{id}/versions/{versionId}/rollback` - 回滚到指定版本

### 4.3 Agent与会话关联API

- `POST /api/sessions/{sessionId}/agent/{agentId}` - 关联会话与Agent
- `GET /api/agents/{agentId}/sessions` - 获取Agent关联的会话列表
- `GET /api/sessions/{sessionId}/agent` - 获取会话关联的Agent

### 4.4 Agent工作区API

- `POST /api/workspace/agents/{agentId}` - 添加Agent到工作区
- `GET /api/workspace/agents` - 获取工作区Agent列表
- `DELETE /api/workspace/agents/{agentId}` - 从工作区移除Agent

### 4.5 Agent高级功能API

- `GET /api/agents/{id}/tools` - 获取Agent可用的工具
- `PUT /api/agents/{id}/tools` - 更新Agent的工具配置
- `GET /api/agents/{id}/knowledge` - 获取Agent关联的知识库
- `PUT /api/agents/{id}/knowledge` - 更新Agent的知识库配置

## 5. 用户界面

### 5.1 Agent列表界面

- 展示个人和市场Agent列表
- 提供创建新Agent的入口
- 工作区Agent优先展示

### 5.2 Agent详情界面

- 显示Agent的基本信息和配置
- 提供编辑和删除功能
- 展示Agent关联的会话历史
- 提供添加到工作区的功能

### 5.3 Agent创建/编辑界面

- 基本信息填写（名称、头像、描述等）
- 系统提示词和欢迎消息配置
- 模型参数配置
- 工具和知识库选择

### 5.4 Agent市场界面

- 展示已上架的公开Agent
- 支持搜索和筛选
- 提供添加到工作区的功能

### 5.5 Agent版本管理界面

- 版本历史列表
- 版本对比功能
- 新版本创建和编辑
- 版本发布和回滚操作
- 版本更新日志编辑

## 6. 安全考虑

- Agent的访问权限控制
- 敏感配置信息的加密存储
- Agent操作的权限验证
- 上架审核机制

## 7. Agent状态管理

Agent系统采用状态机设计来管理Agent的生命周期，通过单一的`status`字段控制。

### 7.1 状态定义

- **0-私有**：仅创建者可见和使用，不会出现在市场中
- **1-待审核**：已提交到市场但尚未通过审核，此时仍然只对创建者可见
- **2-已上架**：审核通过并在市场公开，所有用户可见和使用
- **3-被拒绝**：审核未通过，需要修改后重新提交，只对创建者可见
- **4-已下架**：曾经上架但已被移除，不再在市场中显示，但已添加到工作区的用户仍可使用

### 7.2 状态流转

1. **创建新Agent**：
   - 新建的Agent默认状态为`0-私有`
   - 仅对创建者可见

2. **提交审核**：
   - 创建者可将状态为`0-私有`或`3-被拒绝`的Agent提交审核
   - 提交后状态变为`1-待审核`
   - 系统会通知管理员进行审核

3. **审核流程**：
   - 管理员审核Agent内容和功能
   - 如果通过，则状态变为`2-已上架`
   - 如果拒绝，则状态变为`3-被拒绝`，并提供拒绝理由

4. **下架操作**：
   - 创建者可将状态为`2-已上架`的Agent下架
   - 管理员也可因违规等原因强制下架Agent
   - 下架后状态变为`4-已下架`

5. **重新私有化**：
   - 创建者可将任何状态的Agent重置为`0-私有`
   - 此操作会将Agent从市场中完全移除

6. **删除Agent**：
   - 创建者可以标记删除任何状态的Agent
   - 删除后，Agent数据仍然保留，但设置`deleted_at`字段

### 7.3 状态权限控制

各状态下的操作权限：

| 状态 | 创建者可见 | 市场可见 | 允许编辑 | 允许使用 | 允许下架 |
|------|-----------|---------|----------|----------|----------|
| 0-私有 | ✓ | ✗ | ✓ | ✓ | N/A |
| 1-待审核 | ✓ | ✗ | ✗ | ✓ | ✓ |
| 2-已上架 | ✓ | ✓ | ✗ | ✓ | ✓ |
| 3-被拒绝 | ✓ | ✗ | ✓ | ✓ | N/A |
| 4-已下架 | ✓ | ✗ | ✓ | ✓* | N/A |

*已添加到工作区的用户仍可使用已下架的Agent

## 8. Agent版本控制

Agent版本控制允许创建者管理Agent的演进历史，跟踪变更，以及在需要时回滚到先前的版本。

### 8.1 版本管理模型

- **数据模型分离**：Agent表存储当前编辑中的配置，agent_versions表存储已发布的不可变版本
- **版本号**：采用语义化版本号（如1.0.0，2.1.3）
- **版本内容**：包含完整的Agent配置快照（提示词、工具、知识库等）
- **版本历史**：记录所有历史版本，并提供查看和回滚功能

### 8.2 版本操作流程

1. **Agent创建与编辑**：
   - 创建或编辑Agent时，所有配置都保存在主Agent表中
   - 此时Agent处于"私有"状态，仅创建者可见
   - 可以随时修改配置并保存，不会影响已发布的版本

2. **版本发布**：
   - 当配置完成并经过测试后，创建者点击"发布"
   - 系统将当前配置复制到agent_versions表中
   - 分配一个新的版本号，记录发布时间和更新日志
   - 更新Agent的`published_version`字段指向新创建的版本

3. **版本不可变**：
   - 一旦版本发布，该版本的配置就不可再修改
   - 所有引用该版本的用户都将获得一致的体验

4. **创建新版本**：
   - 需要更新时，创建者可以修改Agent主表中的配置
   - 修改后再次发布，系统会创建一个新的版本记录
   - 版本号必须大于之前的版本号

5. **版本回滚**：
   - 如果新版本出现问题，可以将`published_version`重置为之前的版本ID
   - 回滚不会删除任何版本记录，只是改变当前使用的版本
   - 回滚后，可以基于旧版本重新开始修改

### 8.3 版本应用场景

- **迭代优化**：逐步改进Agent表现和功能
- **A/B测试**：发布不同版本测试效果
- **紧急回滚**：当新版本出现问题时快速恢复
- **版本追踪**：记录Agent的演进历史

### 8.4 与状态管理的关系

- Agent的状态（私有/待审核/已上架等）与其发布版本相关联
- 当Agent有新版本发布时：
  - 如果之前的版本为"私有"，可以直接提交审核
  - 如果之前的版本已"上架"，新版本需要重新审核
  - 用户仍可使用已上架的旧版本，直到新版本通过审核

## 9. 扩展性设计

- 支持自定义Agent模板
- 允许导入/导出Agent配置
- Agent市场评分和推荐系统
- Agent状态流转（私有→待审核→已上架/被拒绝→已下架）
- 版本控制（支持多版本管理和回滚） 