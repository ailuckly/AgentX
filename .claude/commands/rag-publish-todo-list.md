# RAG 发布功能 TODO List

## 阶段一：数据库设计和基础架构 🗄️ ✅ 已完成

### 1. 数据库表创建
- [x] 创建 `rag_versions` 表（RAG版本主表）
- [x] 创建 `rag_version_files` 表（版本文件快照表）
- [x] 创建 `rag_version_documents` 表（版本文档单元快照表）
- [x] 创建 `user_rags` 表（用户安装的RAG表）
- [x] 添加相关索引和约束
- [x] 编写数据库迁移脚本

### 2. 领域层实现
- [x] 创建 `RagVersionEntity` 实体类
- [x] 创建 `RagVersionFileEntity` 实体类
- [x] 创建 `RagVersionDocumentEntity` 实体类
- [x] 创建 `UserRagEntity` 实体类
- [x] 创建相关的Repository接口
- [x] 实现Repository实现类

### 3. 基础领域服务
- [x] 创建 `RagVersionDomainService`
- [x] 创建 `UserRagDomainService`
- [x] 实现快照创建核心逻辑
- [x] 实现向量数据复制逻辑
- [x] 实现数据完整性验证

## 阶段二：快照机制实现 📸 ✅ 已完成

### 1. 快照创建服务
- [x] 实现文件信息快照复制
- [x] 实现文档内容快照复制
- [x] 实现向量数据命名空间复制
- [x] 实现快照统计信息计算
- [x] 添加快照创建事务管理

### 2. 向量数据隔离
- [x] 设计向量数据库命名空间策略
- [x] 实现向量数据复制到新命名空间
- [x] 实现向量数据检索适配
- [x] 添加向量数据清理机制

### 3. 数据一致性保证
- [x] 实现快照完整性验证
- [x] 添加快照创建失败回滚机制
- [x] 实现快照数据校验
- [x] 添加快照创建状态跟踪

## 阶段三：应用层和API实现 🔧 ✅ 已完成

### 1. 应用服务层
- [x] 创建 `RagPublishAppService`
- [x] 创建 `RagMarketAppService`
- [x] 实现RAG发布业务逻辑
- [x] 实现RAG安装业务逻辑
- [x] 实现RAG卸载业务逻辑

### 2. DTO和组装器
- [x] 创建 `RagVersionDTO`
- [x] 创建 `UserRagDTO`
- [x] 创建 `RagMarketDTO`
- [x] 创建 `PublishRagRequest`
- [x] 创建 `InstallRagRequest`
- [x] 创建 `ReviewRagVersionRequest`
- [x] 实现相关的Assembler类

### 3. 控制器层
- [x] 创建 `RagPublishController`
- [x] 创建 `RagMarketController`
- [x] 实现RAG发布API
- [x] 实现RAG市场API
- [x] 实现RAG安装/卸载API

## 阶段四：审核机制实现 ✅ 已完成

### 1. 审核状态管理
- [x] 实现发布状态枚举
- [x] 添加审核状态转换逻辑
- [x] 实现审核时间跟踪
- [x] 添加审核原因记录

### 2. 管理员审核功能
- [x] 创建管理员审核页面
- [x] 实现审核列表查询
- [x] 实现RAG内容预览
- [x] 实现审核操作（通过/拒绝）
- [x] 实现RAG下架功能

### 3. 审核流程API
- [x] 创建 `AdminRagReviewController`
- [x] 实现审核列表API
- [x] 实现审核操作API
- [x] 实现审核历史查询API
- [x] 添加审核通知机制

## 阶段五：前端页面实现 🎨 ✅ 已完成

### 1. 页面结构重构
- [x] 重构知识库主页面为垂直布局结构（采用工具页面模式）
- [x] 创建 `CreatedRagsSection` 组件
- [x] 创建 `InstalledRagsSection` 组件
- [x] 创建 `RecommendedRagsSection` 组件

### 2. RAG卡片组件
- [x] 创建 `CreatedRagCard` 组件
- [x] 创建 `InstalledRagCard` 组件
- [x] 创建 `MarketRagCard` 组件
- [x] 实现卡片交互逻辑（下拉菜单模式）
- [x] 添加卡片状态显示
- [x] 实现点击跳转到详情页面

### 3. 对话框组件
- [x] 创建 `PublishRagDialog` 组件
- [x] 创建 `InstallRagDialog` 组件
- [x] 创建 `RagVersionHistoryDialog` 组件
- [x] 实现对话框表单验证
- [x] 添加对话框状态管理

### 4. 前端服务层
- [x] 创建 `rag-publish-service.ts`
- [x] 实现RAG发布API调用
- [x] 实现RAG安装API调用
- [x] 添加错误处理和Toast提示
- [x] 修复API路径重复问题

### 5. 数据集详情功能
- [x] 数据集详情页面 (`/knowledge/[id]/page.tsx`)
- [x] 文件管理功能（上传、删除、查看）
- [x] 文件处理状态跟踪
- [x] RAG智能问答对话
- [x] 文档搜索功能
- [x] 语料详情查看

## 阶段六：对话集成 💬

### 1. RAG选择器
- [ ] 在对话页面添加RAG选择器
- [ ] 实现RAG列表加载
- [ ] 区分显示创建的和安装的RAG
- [ ] 添加RAG搜索和筛选

### 2. 权限控制
- [ ] 实现RAG使用权限检查
- [ ] 区分创建者和安装者权限
- [ ] 添加权限验证中间件
- [ ] 实现权限错误处理

### 3. 统一检索接口
- [ ] 创建统一的RAG检索服务
- [ ] 实现原始数据集检索
- [ ] 实现版本快照检索
- [ ] 添加检索结果合并逻辑

## 阶段七：管理员后台 👨‍💼 ✅ 已完成

### 1. 审核管理页面
- [x] 创建RAG审核列表页面
- [x] 实现审核状态筛选
- [x] 添加批量审核功能
- [x] 实现审核历史查看

### 2. 内容预览功能
- [x] 实现RAG内容预览
- [x] 显示文件列表和统计
- [x] 支持部分文档内容查看
- [x] 添加内容搜索功能

### 3. 市场管理
- [x] 实现RAG市场管理页面
- [x] 添加RAG下架功能
- [x] 实现使用统计查看

## 阶段八：UI优化和体验改进 ✅ 已完成

### 1. 知识库市场优化
- [x] 实现知识库市场卡片鼠标悬停效果
- [x] 移除文件大小和版本号显示
- [x] 参考工具市场设计风格

### 2. 版本管理优化
- [x] 实现版本号自动递增逻辑
- [x] 知识库创建后自动创建0.0.1版本
- [x] 自动安装新创建的知识库

### 3. 用户体验改进
- [x] 优化已安装知识库卡片设计
- [x] 添加用户自己知识库的删除保护
- [x] 参考工具市场的三点菜单设计

### 4. 系统稳定性
- [x] 修复RAG拒绝API调用的交互问题
- [x] 完善审核流程的用户反馈
- [x] 优化管理员审核体验

## 阶段九：安全性和权限完善 ✅ 已完成

### 1. 用户身份验证修复
- [x] 修复前端用户ID硬编码问题
- [x] 实现JWT token动态解析用户ID
- [x] 添加从API获取用户信息的备用方案
- [x] 更新相关组件支持动态用户ID

### 2. 删除保护机制完善
- [x] 加强后端删除权限检查逻辑
- [x] 实现双重删除保护（版本状态 + 安装状态）
- [x] 防止用户绕过前端直接调用API删除
- [x] 确保前后端删除保护一致性

### 3. 安全性增强
- [x] 完善JWT token解析和错误处理
- [x] 添加用户权限验证的多重保障
- [x] 优化错误提示和用户反馈
- [x] 确保删除保护机制的健壮性

---

## 📊 进度总结

### ✅ 已完成阶段
- **阶段一：数据库设计和基础架构** - 100% 完成
- **阶段二：快照机制实现** - 100% 完成
- **阶段三：应用层和API实现** - 100% 完成
- **阶段四：审核机制实现** - 100% 完成
- **阶段五：前端页面实现** - 100% 完成
- **阶段七：管理员后台** - 100% 完成
- **阶段八：UI优化和体验改进** - 100% 完成
- **阶段九：安全性和权限完善** - 100% 完成

### 🔄 待完成阶段
- **阶段六：对话集成** - 0% 完成

### 📝 当前状态
**后端架构已完成**，包括：
- 数据库表设计和迁移脚本
- Domain层实体类和Repository接口
- 领域服务和业务逻辑
- Application层服务和DTO
- Controller层API接口
- 审核机制和权限控制

**前端页面已完成**，包括：
- 知识库主页面垂直布局重构
- 三个Section组件（创建的、已安装的、推荐的）
- 三个RAG卡片组件（支持下拉菜单交互）
- 三个对话框组件（发布、安装、历史）
- 完整的前端服务层和API调用
- 数据集详情页面和文件管理功能

**管理员后台已完成**，包括：
- RAG审核管理页面和完整审核流程
- 内容预览功能和文件列表展示
- 批量审核和状态筛选功能
- 统计数据展示和下架管理

**UI优化已完成**，包括：
- 知识库市场卡片悬停效果
- 版本号自动递增机制
- 自动安装新创建的知识库
- 用户体验改进和系统稳定性优化

**安全性和权限完善已完成**，包括：
- JWT token动态解析用户身份
- 前后端一致的删除保护机制
- 多重权限验证保障
- 防止API绕过的安全措施

**下一步工作**：
1. 对话集成（RAG选择和使用）

**主要特性**：
- 完整的RAG快照机制
- 审核流程管理
- 用户权限控制
- 分页查询和搜索
- 统一的API接口
